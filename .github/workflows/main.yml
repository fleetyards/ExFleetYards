name: Main

on:
  push:
    branches: ["main", "staging", "trying"]
    tags-ignore:
      - "*.*"
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  credo:
    uses: ./.github/workflows/credo.job.yml
  elixir-build:
    uses: ./.github/workflows/elixir_build.job.yml
  elixir-release:
    uses: ./.github/workflows/elixir_build.job.yml
  publish-docs:
    uses: ./.github/workflows/docs.job.yml
    if: github.ref == 'refs/heads/main'
    needs: [credo, elixir-build, elixir-release]
  deploy-to-stage:
    if: github.ref == 'refs/heads/main'
    needs: [credo, elixir-build, elixir-release]
    uses: ./.github/workflows/deploy.job.yml
    with:
      user: fleetyards-api
      host: ${{ vars.STAGE_HOST }}
      branch: main
    secrets: inherit
